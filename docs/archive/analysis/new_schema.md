-- PostgreSQL: Optimized schema for products/dimensions, negotiations, simulations, and experiments

-- ===== Enums =====
CREATE TYPE side                AS ENUM ('buyer','seller');
CREATE TYPE negotiation_status  AS ENUM ('planned','running','completed','aborted');
CREATE TYPE agent_role          AS ENUM ('buyer','seller','coach','observer','other');
CREATE TYPE agent_kind          AS ENUM ('llm','rule','human','hybrid');
CREATE TYPE value_kind          AS ENUM ('integer','numeric','text','boolean','json');
CREATE TYPE event_kind          AS ENUM ('message','action','tool');

-- ===== Master Data =====
CREATE TABLE markets (
  market_id      BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name           TEXT NOT NULL,
  region         TEXT,
  country_code   TEXT,
  currency_code  TEXT NOT NULL,
  meta           JSONB NOT NULL DEFAULT '{}'
);

CREATE TABLE counterparts (
  counterpart_id   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name             TEXT NOT NULL,
  kind             TEXT NOT NULL CHECK (kind IN ('retailer','manufacturer','distributor','other')),
  power_balance    NUMERIC,
  style            TEXT,
  constraints_meta JSONB NOT NULL DEFAULT '{}',
  notes            TEXT
);

CREATE TABLE dimensions (
  dimension_id   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  code           TEXT UNIQUE NOT NULL,
  name           TEXT NOT NULL,
  value_type     value_kind NOT NULL,
  unit           TEXT,
  spec           JSONB NOT NULL DEFAULT '{}'
);

CREATE TABLE products (
  product_id     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  gtin           TEXT UNIQUE,
  name           TEXT NOT NULL,
  brand          TEXT,
  category_path  TEXT,
  attrs          JSONB NOT NULL DEFAULT '{}'
);

-- History-friendly product â†” dimension values
CREATE TABLE product_dimension_values (
  product_id     BIGINT NOT NULL REFERENCES products(product_id) ON DELETE CASCADE,
  dimension_id   BIGINT NOT NULL REFERENCES dimensions(dimension_id) ON DELETE CASCADE,
  value          JSONB  NOT NULL,
  measured_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  source         TEXT,
  PRIMARY KEY (product_id, dimension_id, measured_at)
);

-- ===== Registration / Setup =====
CREATE TABLE registrations (
  registration_id    BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  organization       TEXT NOT NULL,
  company            TEXT,
  country            TEXT,
  market_id          BIGINT REFERENCES markets(market_id),
  negotiation_type   TEXT,
  negotiation_frequency TEXT,
  goals              JSONB NOT NULL DEFAULT '{}',
  created_at         TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ===== Negotiations =====
CREATE TABLE negotiations (
  negotiation_id   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  registration_id  BIGINT NOT NULL REFERENCES registrations(registration_id) ON DELETE CASCADE,
  market_id        BIGINT REFERENCES markets(market_id),
  counterpart_id   BIGINT REFERENCES counterparts(counterpart_id),
  scenario         JSONB NOT NULL DEFAULT '{}',
  status           negotiation_status NOT NULL DEFAULT 'planned',
  started_at       TIMESTAMPTZ,
  ended_at         TIMESTAMPTZ,
  CONSTRAINT chk_neg_times CHECK (ended_at IS NULL OR ended_at >= started_at)
);

-- Many products per negotiation
CREATE TABLE negotiation_products (
  negotiation_id BIGINT NOT NULL REFERENCES negotiations(negotiation_id) ON DELETE CASCADE,
  product_id     BIGINT NOT NULL REFERENCES products(product_id),
  PRIMARY KEY (negotiation_id, product_id)
);

CREATE TABLE negotiation_rounds (
  round_id       BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  negotiation_id BIGINT NOT NULL REFERENCES negotiations(negotiation_id) ON DELETE CASCADE,
  round_no       INT NOT NULL,
  state          JSONB NOT NULL DEFAULT '{}',
  started_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  ended_at       TIMESTAMPTZ,
  CONSTRAINT chk_round_times CHECK (ended_at IS NULL OR ended_at >= started_at),
  UNIQUE (negotiation_id, round_no)
);

-- ===== Simulations & Agents =====
CREATE TABLE simulations (
  simulation_id   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  registration_id BIGINT NOT NULL REFERENCES registrations(registration_id) ON DELETE CASCADE,
  name            TEXT,
  settings        JSONB NOT NULL DEFAULT '{}',
  num_rounds      INT,
  seed            INT,
  started_at      TIMESTAMPTZ,
  ended_at        TIMESTAMPTZ,
  CONSTRAINT chk_sim_times CHECK (ended_at IS NULL OR ended_at >= started_at)
);

CREATE TABLE policies (
  policy_id     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name          TEXT NOT NULL,
  kind          TEXT,
  config        JSONB NOT NULL DEFAULT '{}'
);

CREATE TABLE agents (
  agent_id        BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  registration_id BIGINT REFERENCES registrations(registration_id),
  simulation_id   BIGINT REFERENCES simulations(simulation_id) ON DELETE CASCADE,
  role            agent_role,
  agent_kind      agent_kind,
  model_name      TEXT,
  system_prompt   TEXT,
  tools           JSONB NOT NULL DEFAULT '[]',
  policy_id       BIGINT REFERENCES policies(policy_id),
  hyperparams     JSONB NOT NULL DEFAULT '{}'
);

CREATE TABLE agent_metrics (
  agent_metric_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  agent_id        BIGINT NOT NULL REFERENCES agents(agent_id) ON DELETE CASCADE,
  metric_name     TEXT NOT NULL,
  metric_value    NUMERIC,
  details         JSONB NOT NULL DEFAULT '{}',
  recorded_at     TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Step/reward tracking (optional RL-style)
CREATE TABLE interactions (
  interaction_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  round_id       BIGINT NOT NULL REFERENCES negotiation_rounds(round_id) ON DELETE CASCADE,
  step_no        INT,
  agent_id       BIGINT REFERENCES agents(agent_id),
  observation    JSONB NOT NULL DEFAULT '{}',
  reward         NUMERIC,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Unified event log (messages, actions, tool calls)
CREATE TABLE events (
  event_id      BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  round_id      BIGINT NOT NULL REFERENCES negotiation_rounds(round_id) ON DELETE CASCADE,
  event_kind    event_kind NOT NULL,
  role          TEXT,         -- "system","user","assistant","tool" if message-like
  agent_id      BIGINT REFERENCES agents(agent_id),
  name          TEXT,         -- action/message/tool name
  parameters    JSONB NOT NULL DEFAULT '{}',
  observations  JSONB NOT NULL DEFAULT '{}',
  reasoning     TEXT,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Offers (tie to round; agent optional for provenance)
CREATE TABLE offers (
  offer_id       BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  round_id       BIGINT NOT NULL REFERENCES negotiation_rounds(round_id) ON DELETE CASCADE,
  side           side NOT NULL,
  agent_id       BIGINT REFERENCES agents(agent_id),
  price          NUMERIC,
  quantity       NUMERIC,
  currency_code  TEXT,
  unit           TEXT,
  terms          JSONB NOT NULL DEFAULT '{}',  -- payment, delivery, listing fees, rebates ...
  expires_at     TIMESTAMPTZ,
  accepted       BOOLEAN NOT NULL DEFAULT FALSE,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE concessions (
  concession_id  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  offer_id       BIGINT NOT NULL REFERENCES offers(offer_id) ON DELETE CASCADE,
  field_path     TEXT,
  before_value   JSONB,
  after_value    JSONB
);

-- ===== Benchmarks & Experiments =====
CREATE TABLE benchmarks (
  benchmark_id  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name          TEXT NOT NULL,
  description   TEXT,
  dataset       JSONB NOT NULL DEFAULT '{}'
);

CREATE TABLE experiments (
  experiment_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  benchmark_id  BIGINT REFERENCES benchmarks(benchmark_id),
  name          TEXT NOT NULL,
  hypothesis    TEXT,
  design        JSONB NOT NULL DEFAULT '{}',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE experiment_runs (
  run_id        BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  experiment_id BIGINT NOT NULL REFERENCES experiments(experiment_id) ON DELETE CASCADE,
  simulation_id BIGINT REFERENCES simulations(simulation_id),
  batch_label   TEXT,
  started_at    TIMESTAMPTZ,
  ended_at      TIMESTAMPTZ,
  metrics       JSONB NOT NULL DEFAULT '{}',
  result_summary TEXT,
  CONSTRAINT chk_run_times CHECK (ended_at IS NULL OR ended_at >= started_at)
);

-- ===== Indexes =====
CREATE INDEX ON product_dimension_values (dimension_id);
CREATE INDEX ON product_dimension_values USING GIN (value jsonb_path_ops);

CREATE INDEX ON registrations (market_id);
CREATE INDEX ON negotiations (registration_id);
CREATE INDEX ON negotiations (counterpart_id);
CREATE INDEX ON negotiation_rounds (negotiation_id);

CREATE INDEX ON negotiation_products (product_id);

CREATE INDEX ON events (round_id);
CREATE INDEX ON events (agent_id);

CREATE INDEX ON offers (round_id);
CREATE INDEX ON offers (agent_id, accepted);

CREATE INDEX ON interactions (round_id);
CREATE INDEX ON interactions (agent_id);

CREATE UNIQUE INDEX products_gtin_uniq ON products (gtin) WHERE gtin IS NOT NULL;